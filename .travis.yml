dist: trusty
sudo: false

cache:
  directories:
    - lib

language: java
jdk:
  - oraclejdk8
  - openjdk8

# https://docs.travis-ci.com/user/database-setup/#Using-a-different-PostgreSQL-Version

#      - https://github.com/oltpbenchmark/oltpbench/issues/137
#matrix:
#  allow_failures:
#    - jdk: oraclejdk9


addons:
  apt:
    packages:
      # Travis CI fast containers on dist=trusty have a bug with
      # services/mysql not working without this.
      # <https://github.com/travis-ci/travis-ci/issues/5837>
      # <https://github.com/travis-ci/travis-ci/issues/6842>
      - mysql-server-5.6
      - mysql-client-core-5.6
      - mysql-client-5.6
 
# mariadb not on trust-containers yet: https://github.com/travis-ci/travis-ci/issues/5837#issuecomment-283293637
# 
# mariadb: "10.2"
addons:
  postgresql: "9.6"

# While mariadb addon isn't used
services:
  - mysql

#matrix:
#  include:
#    - addons:
#      mariadb: 5.5
#    - addons:
#      mariadb: 10.0
#    - addons:
#      mariadb: 10.1
#    - addons:
#      mariadb: 10.2
#    - addons:
#      postgresql: 9.4
#    - addons:
#      postgresql: 9.5
#    - addons:
#      postgresql: 9.6
#    - addons:
#      postgresql: 9.7

install: echo "Done"
before_script:
  - dpkg -l | egrep -i '(mysql|mariadb)'
  - ps -ef | grep mysqld
  - for db in tpcc tpch tatp wikipedia resourcestresser twitter epinions ycsb
                                jpab seats auctionmark chbenchmark 
                                voter linkbench sibench noop
                                smallbank hyadapt ; do 
      psql -c "create database $db" -U postgres ;
      mysql -e "CREATE DATABASE IF NOT EXISTS $db" ;
    done
  - psql -c "ALTER USER CURRENT_USER WITH PASSWORD 'travis'" -U travis ;
  - mysql -e "SET PASSWORD FOR 'travis'@'localhost' = PASSWORD('travis')";

script:
  - ant junit
  - for test in sample_epinions_config.xml  sample_auctionmark_config.xml sample_voter_config.xml; do
      sed -i -e '/<DBUrl>/s/server/localhost/'
           -e '/<username>/c\<username>travis</username>'
           -e '/<password>/c\<password>travis</password>'
           -e '/<scalefactor>/s/[0-9]*/1/' "config/${test}";
      testname=${test#sample_}; testname=${testname%_config.xml} ;
      ./oltpbenchmark --bench "${testname}" --config config/"${test}"  --create true    --load true   --execute true ;
    done
